<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word 模板生成工具</title>
    
    <!-- 思源黑体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 样式 -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- 第三方库 - 本地版本（无需网络，无需服务器） -->
    <script src="libs/pizzip.min.js"></script>
    <script src="libs/docxtemplater.min.js"></script>
    <script src="libs/FileSaver.min.js"></script>
    
    <!-- 检测库是否加载成功 -->
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            var missing = [];
            if (typeof PizZip === 'undefined') missing.push('PizZip');
            if (typeof docxtemplater === 'undefined') missing.push('docxtemplater');
            if (typeof saveAs === 'undefined') missing.push('FileSaver');
            
            if (missing.length > 0) {
                document.body.innerHTML = '<div style="max-width:600px;margin:100px auto;padding:40px;text-align:center;font-family:system-ui,sans-serif;">' +
                    '<h2 style="color:#FF3B30;">⚠️ 依赖库加载失败</h2>' +
                    '<p style="color:#666;margin:20px 0;">以下库未能加载：<strong>' + missing.join(', ') + '</strong></p>' +
                    '<p style="color:#666;">请尝试以下解决方案：</p>' +
                    '<ol style="text-align:left;color:#333;line-height:2;">' +
                    '<li>检查网络连接</li>' +
                    '<li>使用本地服务器运行（推荐）：<br><code style="background:#f5f5f5;padding:4px 8px;border-radius:4px;">python -m http.server 8080</code><br>然后访问 <a href="http://localhost:8080">http://localhost:8080</a></li>' +
                    '<li>或使用支持 file:// 协议的浏览器（如 Firefox）</li>' +
                    '</ol></div>';
            }
        });
    </script>
</head>
<body>
    <!-- 应用容器 -->
    <div id="app">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <rect width="32" height="32" rx="8" fill="#007AFF"/>
                        <path d="M8 10h16v2H8v-2zm0 5h16v2H8v-2zm0 5h10v2H8v-2z" fill="white"/>
                    </svg>
                    <span>模板工具</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="templates">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M3 3h6v6H3V3zm8 0h6v6h-6V3zm-8 8h6v6H3v-6zm8 0h6v6h-6v-6z"/>
                    </svg>
                    <span>模板列表</span>
                </a>
                <a href="#" class="nav-item" data-view="history">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 8V5H9v6h5v-2h-3z"/>
                    </svg>
                    <span>历史记录</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn-icon" id="btn-workspace" title="设置工作区（本地文件存储）">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M4 4h12v2H4V4zm0 4h12v2H4V8zm0 4h12v2H4v-2zm0 4h8v2H4v-2z" stroke="currentColor" fill="none"/>
                    </svg>
                </button>
                <button class="btn-icon" id="btn-backup" title="备份数据">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2l6 6h-4v6H8V8H4l6-6zm-6 12v2h12v-2H4z"/>
                    </svg>
                </button>
                <button class="btn-icon" id="btn-restore" title="恢复数据">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 14l-6-6h4V2h4v6h4l-6 6zm-6 2v2h12v-2H4z"/>
                    </svg>
                </button>
            </div>
        </aside>
        <div id="sidebar-backdrop" class="sidebar-backdrop" aria-hidden="true"></div>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 模板列表视图 -->
            <div id="view-templates" class="view active">
                <header class="view-header">
                    <button class="btn-icon btn-nav-toggle" type="button" title="菜单">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    <h1>模板列表</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="btn-import-template">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 10l-4-4h3V2h2v4h3l-4 4zm-6 2v2h12v-2H2z"/>
                            </svg>
                            导入模板
                        </button>
                        <button class="btn btn-primary" id="btn-new-template">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" fill="none"/>
                            </svg>
                            新建模板
                        </button>
                    </div>
                </header>
                <div class="template-grid" id="template-grid">
                    <!-- 模板卡片由 JS 动态生成 -->
                    <div class="empty-state" id="empty-templates">
                        <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                            <rect x="8" y="8" width="48" height="48" rx="8" stroke="#C7C7CC" stroke-width="2" fill="none"/>
                            <path d="M24 32h16M32 24v16" stroke="#C7C7CC" stroke-width="2"/>
                        </svg>
                        <h3>暂无模板</h3>
                        <p>点击"新建模板"创建你的第一个模板</p>
                    </div>
                </div>
            </div>

            <!-- 模板编辑视图 -->
            <div id="view-template-edit" class="view">
                <header class="view-header">
                    <button class="btn-icon btn-nav-toggle" type="button" title="菜单">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    <button class="btn-back" id="btn-back-from-edit">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12 4l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        返回
                    </button>
                    <h1 id="edit-title">新建模板</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="btn-check-template">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 1a7 7 0 100 14A7 7 0 008 1zm1 10H7V9h2v2zm0-3H7V4h2v4z"/>
                            </svg>
                            模板自检
                        </button>
                        <button class="btn btn-primary" id="btn-save-template">
                            保存模板
                        </button>
                    </div>
                </header>
                <div class="edit-content">
                    <!-- 基本信息 -->
                    <section class="edit-section">
                        <h2>基本信息</h2>
                        <div class="form-group">
                            <label for="template-name">模板名称 <span class="required">*</span></label>
                            <input type="text" id="template-name" placeholder="请输入模板名称" required>
                        </div>
                        <div class="form-group">
                            <label for="template-desc">模板描述</label>
                            <textarea id="template-desc" placeholder="请输入模板描述（可选）" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Word 模板文件 <span class="required">*</span></label>
                            <div class="file-upload" id="word-upload-area">
                                <input type="file" id="word-file-input" accept=".docx" hidden>
                                <div class="file-upload-content">
                                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                                        <rect x="4" y="4" width="32" height="32" rx="4" fill="#E8F0FE"/>
                                        <path d="M12 20h16M20 12v16" stroke="#007AFF" stroke-width="2"/>
                                    </svg>
                                    <p>点击或拖拽上传 Word 文件</p>
                                    <span class="file-hint">支持 .docx 格式</span>
                                </div>
                                <div class="file-info" id="word-file-info" style="display: none;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#007AFF">
                                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                                        <path d="M14 2v6h6" fill="white"/>
                                    </svg>
                                    <span class="file-name"></span>
                                    <button class="btn-remove-file" title="移除文件">×</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 字段配置 -->
                    <section class="edit-section">
                        <div class="section-header">
                            <h2>字段配置</h2>
                            <button class="btn btn-small btn-secondary" id="btn-add-field">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                                    <path d="M7 1v12M1 7h12" stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                                添加字段
                            </button>
                        </div>
                        <div class="field-list" id="field-list">
                            <!-- 字段项由 JS 动态生成 -->
                        </div>
                    </section>

                    <!-- 明细表配置 -->
                    <section class="edit-section">
                        <div class="section-header">
                            <h2>明细表配置</h2>
                            <button class="btn btn-small btn-secondary" id="btn-add-table">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor">
                                    <path d="M7 1v12M1 7h12" stroke="currentColor" stroke-width="2" fill="none"/>
                                </svg>
                                添加明细表
                            </button>
                        </div>
                        <div class="table-config-list" id="table-config-list">
                            <!-- 明细表配置由 JS 动态生成 -->
                            <div class="empty-hint" id="empty-tables">
                                <p>暂无明细表，点击"添加明细表"创建（最多3张）</p>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- 填写生成视图 -->
            <div id="view-form-fill" class="view">
                <header class="view-header">
                    <button class="btn-icon btn-nav-toggle" type="button" title="菜单">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    <button class="btn-back" id="btn-back-from-form">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12 4l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        返回
                    </button>
                    <h1 id="form-title">填写表单</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="btn-load-history">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 2a6 6 0 100 12A6 6 0 008 2zm1 6V4H7v5h4V7H9z"/>
                            </svg>
                            从历史载入
                        </button>
                        <button class="btn btn-secondary" id="btn-save-record">
                            保存记录
                        </button>
                        <button class="btn btn-primary" id="btn-generate-word">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 10l-4-4h3V2h2v4h3l-4 4zm-6 2v2h12v-2H2z"/>
                            </svg>
                            生成 Word
                        </button>
                    </div>
                </header>
                <div class="form-fill-content">
                    <!-- 文件名 -->
                    <section class="form-section">
                        <h2>导出设置</h2>
                        <div class="form-group">
                            <label for="output-filename">文件名 <span class="required">*</span></label>
                            <input type="text" id="output-filename" placeholder="请输入导出的文件名（不需要加.docx后缀）" required>
                            <span class="field-hint">生成的 Word 文件将以此命名</span>
                        </div>
                    </section>

                    <!-- 普通字段 -->
                    <section class="form-section">
                        <h2>基本信息</h2>
                        <div class="dynamic-form" id="dynamic-form">
                            <!-- 由 JS 动态生成 -->
                        </div>
                    </section>

                    <!-- 明细表 -->
                    <div id="detail-tables-container">
                        <!-- 由 JS 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 历史记录视图 -->
            <div id="view-history" class="view">
                <header class="view-header">
                    <button class="btn-icon btn-nav-toggle" type="button" title="菜单">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    <h1>历史记录</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" id="btn-import-records">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 10l-4-4h3V2h2v4h3l-4 4zm-6 2v2h12v-2H2z"/>
                            </svg>
                            导入数据包
                        </button>
                        <button class="btn btn-secondary" id="btn-export-records">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 2l6 6h-4v6H8V8H4l4-6zm-6 12v2h12v-2H4z"/>
                            </svg>
                            导出数据包
                        </button>
                    </div>
                </header>
                <div class="history-filters">
                    <div class="filter-group">
                        <label>选择模板</label>
                        <select id="history-template-filter">
                            <option value="">全部模板</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>开始日期</label>
                        <input type="date" id="history-date-start">
                    </div>
                    <div class="filter-group">
                        <label>结束日期</label>
                        <input type="date" id="history-date-end">
                    </div>
                    <button class="btn btn-small btn-secondary" id="btn-filter-history">筛选</button>
                    <button class="btn btn-small btn-text" id="btn-clear-filter">清除</button>
                </div>
                <div class="history-list" id="history-list">
                    <!-- 由 JS 动态生成 -->
                    <div class="empty-state" id="empty-history">
                        <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                            <circle cx="32" cy="32" r="24" stroke="#C7C7CC" stroke-width="2" fill="none"/>
                            <path d="M32 16v18l12 6" stroke="#C7C7CC" stroke-width="2" fill="none"/>
                        </svg>
                        <h3>暂无记录</h3>
                        <p>填写并保存表单后，记录将显示在这里</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 模态框容器 -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 id="modal-title">标题</h3>
                <button class="btn-close" id="modal-close">×</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- 动态内容 -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- 动态按钮 -->
            </div>
        </div>
    </div>

    <!-- Toast 提示 -->
    <div class="toast-container" id="toast-container"></div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="import-template-input" accept=".templatepack" hidden>
    <input type="file" id="import-records-input" accept=".recordspack" hidden>

    <!-- 应用脚本 -->
    <script src="js/storage.js"></script>
    <script src="js/storage-file.js"></script>
    <script src="js/storage-adapter.js"></script>
    <script src="js/template.js"></script>
    <script src="js/form.js"></script>
    <script src="js/word.js"></script>
    <script src="js/export.js"></script>
    <script src="js/app.js"></script>
</body>
</html>

